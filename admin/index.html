<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>YAML Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    :root{--bg:#fafafa;--card:#fff;--bd:#e5e7eb;--txt:#111827;--mut:#6b7280;--pri:#0ea5e9;--warn:#b45309}
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
    #app{display:flex;flex-direction:column;height:100vh}
    header{padding:10px 16px;border-bottom:1px solid var(--bd);background:#fff;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    header h1{font-size:16px;margin:0}
    .btn{padding:8px 10px;border:1px solid var(--bd);border-radius:8px;background:#f5f5f5;cursor:pointer}
    .ok{background:var(--pri);color:#fff;border-color:var(--pri)}
    .mut{color:var(--mut)}
    main{flex:1;display:grid;grid-template-columns:320px 1fr;min-height:0}
    aside{border-right:1px solid var(--bd);background:#fff;display:flex;flex-direction:column}
    .bar{padding:10px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px}
    .bar select,.bar input{width:100%;padding:8px;border:1px solid var(--bd);border-radius:8px}
    .list{flex:1;overflow:auto}
    .item{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd);cursor:pointer}
    .item:hover{background:#f9fafb}
    .item.active{background:#eef6ff}
    .tag{font-size:12px;color:var(--mut)}
    .pill{font-size:11px;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;background:#f9fafb}
    section{padding:16px;overflow:auto}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    label{display:block;margin-bottom:4px;font-size:12px;color:#374151}
    input,select,textarea{width:100%;padding:8px;border:1px solid var(--bd);border-radius:8px;font:inherit}
    textarea{resize:vertical;min-height:80px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
    .line{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .danger{background:#ef4444;color:#fff;border-color:#ef4444}
    .primary{background:var(--pri);color:#fff;border-color:var(--pri)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:sticky;top:0;background:#fff;padding:8px;border-bottom:1px solid var(--bd);z-index:1}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>üõ† YAML Admin Panel</h1>
    <button v-if="!tok" class="btn ok" @click="login">üîê Login</button>
    <button v-else class="btn" @click="logout">üö™ Logout</button>
    <span v-if="tok" class="mut">Token in sessionStorage.</span>
    <span class="mut">| Repo:</span> <strong>{{repo}}</strong>
  </header>
  <main v-if="tok">
    <aside>
      <div class="bar">
        <select v-model="file" @change="loadFile">
          <option v-for="f in files" :key="f.name" :value="f">{{f.name}}</option>
        </select>
      </div>
      <div class="bar">
        <input v-model="q" placeholder="Search items...">
      </div>
      <div class="bar">
        <button class="btn" @click="addItem">Ôºã Add</button>
        <button class="btn" @click="dupItem" :disabled="sel<0">‚ßâ Dup</button>
        <button class="btn danger" @click="delItem" :disabled="sel<0">üóë Del</button>
      </div>
      <div class="list">
        <div v-for="r in rows" :key="r.idx" class="item" :class="{active:r.idx===sel}" @click="open(r.idx)">
          <span>{{labelOf(r.row)}}</span><span class="tag">#{{r.idx+1}}</span>
        </div>
      </div>
    </aside>
    <section>
      <div class="toolbar">
        <button class="btn" @click="prev" :disabled="sel<=0">‚Üê Prev</button>
        <button class="btn" @click="next" :disabled="sel>=data.length-1">Next ‚Üí</button>
        <button class="btn" @click="moveItem(-1)" :disabled="sel<=0">‚¨Ü Up</button>
        <button class="btn" @click="moveItem(1)" :disabled="sel>=data.length-1">‚¨á Down</button>
        <button class="btn" @click="save" :disabled="sel<0">üíæ Save</button>
        <button class="btn" @click="reload">‚Üª Reload</button>
      </div>
      <div v-if="sel<0" class="mut">Select an item.</div>
      <div v-else class="card grid">
        <template v-for="fld in schema.fields" :key="fld.k">
          <div :class="'col-6'" v-if="['text','url','date','select','number'].includes(fld.t)">
            <label>{{fld.l}}</label>
            <input v-if="fld.t!=='select'" :type="fld.t" v-model="cur[fld.k]">
            <select v-else v-model="cur[fld.k]">
              <option v-for="o in (fld.opts||[])" :value="o">{{o}}</option>
            </select>
          </div>
          <div class="col-12" v-if="fld.t==='long'">
            <label>{{fld.l}}</label><textarea v-model="cur[fld.k]" rows="4"></textarea>
          </div>
          <div class="col-12" v-if="fld.t==='sublist'">
            <label>{{fld.l}}</label>
            <div v-for="(it,i) in cur[fld.k]" :key="i" class="card row">
              <template v-for="sf in fld.fields">
                <div class="col-6"><label>{{sf.l}}</label>
                  <input v-model="it[sf.k]">
                </div>
              </template>
              <div class="col-12"><button class="btn danger" @click="cur[fld.k].splice(i,1)">Remove</button></div>
            </div>
            <button class="btn" @click="cur[fld.k].push({})">Ôºã Add {{fld.l}}</button>
          </div>
        </template>
      </div>
    </section>
  </main>
</div>
<script>
(()=>{
  const {createApp,ref,reactive,computed} = Vue;
  createApp({
    setup(){
      const repo='uapmnlcorinthian/uapmnlcorinthian.github.io', br='main';
      const baseYml='_data', schemaFile='_schemas.yml', baseMd='_events';
      const tok=ref(sessionStorage.getItem('gh_token')||'');
      const files=ref([]), file=ref(null);
      const SC=reactive({}), schema=reactive({type:'array',fields:[],display:''});
      const data=ref([]), sha=ref(''), sel=ref(-1), q=ref('');
      const sortMode=ref('index');

      const headers=()=>({Authorization:`Bearer ${tok.value}`});
      const labelOf=e=>e[schema.display]||e.title||'Item';
      
      const fetchJSON=async path=>{const r=await fetch(`https://api.github.com/${path}?ref=${br}`,{headers:headers()});return r.ok?await r.json():[];};
      const ghJSON=async path=>{const r=await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${br}`,{headers:headers()});if(!r.ok) return null;const j=await r.json();let text=atob(j.content.replace(/(^\uFEFF|\u0000)/g,''));text=text.replace(/[\u0000-\u001F\u007F-\u009F]/g,'');return{text,sha:j.sha};};
      const ghPUT=async(p,c,ps)=>await fetch(`https://api.github.com/repos/${repo}/contents/${p}`,{method:'PUT',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify({message:`Update ${p}`,content:btoa(unescape(encodeURIComponent(c))),sha:ps,branch:br})});
      
      const loadSchemas=async()=>{const r=await ghJSON(`${baseYml}/${schemaFile}`);if(r)Object.assign(SC,jsyaml.load(r.text)||{});};
      const listFiles=async()=>{const y=await fetchJSON(`repos/${repo}/contents/${baseYml}`);files.value=y.filter(f=>f.name.endsWith('.yml')&&f.name!==schemaFile).map(f=>({name:f.name,type:'yml'}));files.value.push({name:'Events',type:'mdlist'});file.value=files.value[0];sel.value=-1;};
      const listEvents=async()=>{const lst=await fetchJSON(`repos/${repo}/contents/${baseMd}`);return Promise.all(lst.filter(f=>f.name.endsWith('.md')).map(async f=>{const r=await ghJSON(`${baseMd}/${f.name}`);const fm=(r.text.match(/---[\s\S]*?---/)||[''])[0];const doc=jsyaml.load(fm.replace(/---/g,''));if(doc.event_date&&!/^\d{4}-\d{2}-\d{2}$/.test(doc.event_date))doc.event_date=new Date(doc.event_date).toISOString().slice(0,10);return doc;}));};
      const inferFields=r=>Object.keys(r||{}).map(k=>({k,l:k.replace(/[_-]+/g,' '),t:typeof r[k]==='boolean'?'bool':Array.isArray(r[k])?'list':/^\d{4}-\d{2}-\d{2}$/.test(r[k])?'date':'text'}));
      const pickSchema=(k,d)=>{const s=SC[k];if(s)Object.assign(schema,s);else if(Array.isArray(d)){schema.type='array';schema.fields=inferFields(d[0]);schema.display=schema.fields[0].k;}};
      const loadFile=async()=>{if(!file.value)return;if(file.value.type==='mdlist'){const ev=await listEvents();pickSchema('_events',ev);data.value=ev;sel.value=ev.length?0:-1;}else{const r=await ghJSON(`${baseYml}/${file.value.name}`);const arr=jsyaml.load(r.text)||[];pickSchema(file.value.name,arr);data.value=arr;sel.value=arr.length?0:-1;sha.value=r.sha;}};
      const open=i=>sel.value=i;
      const cur=computed(()=>data.value[sel.value]||{});
      const objFromFields=f=>{const o={};f.forEach(x=>o[x.k]=x.t==='list'?[]:x.t==='bool'?false:'');return o;};
      const addItem=()=>{data.value.push(objFromFields(schema.fields));sel.value=data.value.length-1;};
      const dupItem=()=>{const c=JSON.parse(JSON.stringify(cur.value));data.value.splice(sel.value+1,0,c);sel.value++;};
      const delItem=()=>{if(confirm('Delete?')){data.value.splice(sel.value,1);sel.value=Math.min(sel.value,data.value.length-1);}};
      const moveItem=d=>{const i=sel.value,j=i+d;[data.value[i],data.value[j]]=[data.value[j],data.value[i]];sel.value=j;};
      const reload=loadFile;
      const exportYaml=()=>{};
      const validate=()=>{for(const f of schema.fields)if(f.req&&!cur.value[f.k])return alert(`${f.l} required`),false;return true;};
      const save=async()=>{if(!validate())return;let c;if(file.value.type==='mdlist')c='---\n'+jsyaml.dump(cur.value)+'---';else c=jsyaml.dump(data.value);const p=file.value.type==='mdlist'?`${baseMd}/${cur.value.slug}.md`:`${baseYml}/${file.value.name}`;const res=await ghPUT(p,c,sha.value);alert(res.ok?'Saved':'Fail');if(res.ok)loadFile();};
      const prev=()=>{if(sel.value>0)sel.value--;};
      const next=()=>{if(sel.value<data.value.length-1)sel.value++;};
      const rows=computed(()=>{if(schema.type==='map')return[];let a=data.value.map((r,i)=>({row:r,idx:i}));if(q.value)a=a.filter(x=>labelOf(x.row).toLowerCase().includes(q.value.toLowerCase()));return sortMode.value==='name'?a.sort((x,y)=>labelOf(x.row).localeCompare(labelOf(y.row))):a;});
      const inputType=f=>f.t==='date'?'date':f.t==='datetime'?'datetime-local':f.t==='number'?'number':'text';
      const login=()=>{const t=prompt('Token');if(!t)return;tok.value=t;sessionStorage.setItem('gh_token',t);init();};
      const logout=()=>{sessionStorage.removeItem('gh_token');location.reload();};
      const init=async()=>{await loadSchemas();await listFiles();if(file.value)await loadFile();};
      if(tok.value)init();
      return{repo,tok,files,file,schema,data,sel,q,sortMode,rows,cur,labelOf,inputType,login,logout,loadFile,addItem,dupItem,delItem,moveItem,reload,exportYaml,save,prev,next};
    }
  }).mount('#app');
})();
</script>
